<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>House Hunter üè°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />

  <!-- STEP 1: Paste your Firebase config here -->
  <script type="module">
    // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDOd8CN2k-PBxv5_wwdRYdjjJ2nFn7wx70",
    authDomain: "house-hunter-b211d.firebaseapp.com",
    databaseURL: "https://house-hunter-b211d-default-rtdb.firebaseio.com",
    projectId: "house-hunter-b211d",
    storageBucket: "house-hunter-b211d.firebasestorage.app",
    messagingSenderId: "394632511568",
    appId: "1:394632511568:web:6342315041ec7d42f85155",
    measurementId: "G-8LFNL3Y4D6"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
    const DATA_REF = ref(db, "house-hunter");

    // Expose save/subscribe to the rest of the page
    window._fbSubscribe = (cb) => onValue(DATA_REF, (snap) => cb(snap.val()));
    window._fbSave      = (data) => set(DATA_REF, data);
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0f1117; color: #e2e8f0; font-family: 'DM Sans', sans-serif; min-height: 100vh; }

    input, textarea, select {
      background: #1a1f2e; border: 1px solid #2d3748; color: #e2e8f0;
      border-radius: 8px; padding: 8px 12px; font-family: inherit;
      font-size: 14px; width: 100%; outline: none; transition: border-color .2s;
    }
    input:focus, textarea:focus { border-color: #c084fc; }
    input[type=date] { color-scheme: dark; }
    input[type=checkbox] { width: auto; accent-color: #c084fc; }
    input[type=range] {
      -webkit-appearance: none; height: 6px; border-radius: 3px;
      background: #2d3748; border: none; padding: 0; cursor: pointer;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
      background: linear-gradient(135deg,#c084fc,#818cf8); cursor: pointer;
    }
    label { font-size: 12px; color: #94a3b8; font-weight: 500; letter-spacing: .05em; text-transform: uppercase; display: block; margin-bottom: 4px; }

    .btn { cursor: pointer; border: none; border-radius: 8px; padding: 10px 20px; font-family: inherit; font-weight: 600; font-size: 14px; transition: all .2s; display: inline-block; }
    .btn-primary  { background: linear-gradient(135deg,#c084fc,#818cf8); color: #fff; }
    .btn-primary:hover  { opacity: .9; transform: translateY(-1px); }
    .btn-secondary { background: #1e2535; color: #94a3b8; border: 1px solid #2d3748; }
    .btn-secondary:hover { background: #2d3748; color: #e2e8f0; }
    .btn-danger { background: transparent; color: #f87171; border: 1px solid #f87171; }
    .btn-danger:hover { background: #f87171; color: #fff; }
    .btn-sm { padding: 7px 14px; font-size: 13px; }

    #app { max-width: 940px; margin: 0 auto; padding: 0 16px 48px; }

    /* Header */
    #header {
      background: #0d1018; border-bottom: 1px solid #1e2535;
      padding: 14px 24px; display: flex; align-items: center;
      justify-content: space-between; position: sticky; top: 0; z-index: 100;
    }
    #header-left { display: flex; align-items: center; gap: 12px; }
    #header-title { font-family: 'Playfair Display', serif; font-size: 18px; color: #e2e8f0; }
    #header-sub { font-size: 11px; color: #64748b; font-family: 'DM Mono', monospace; }
    #header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    /* Weights panel */
    #weights-panel { background: #11151f; border-bottom: 1px solid #1e2535; padding: 20px 24px; display: none; }
    #weights-panel.open { display: block; }
    #weights-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 16px; max-width: 860px; }
    .weight-row { }
    .weight-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .weight-badge { font-family: 'DM Mono', monospace; font-size: 13px; color: #c084fc; background: #c084fc15; padding: 2px 8px; border-radius: 6px; }

    /* Toast */
    #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1e2535; border: 1px solid #2d3748; color: #e2e8f0; padding: 10px 20px; border-radius: 10px; font-size: 14px; z-index: 999; opacity: 0; transition: opacity .3s; pointer-events: none; }
    #toast.show { opacity: 1; }

    /* Cards */
    .house-card { background: #161b27; border: 1px solid #1e2535; border-radius: 16px; padding: 20px; transition: all .2s; cursor: pointer; margin-bottom: 12px; }
    .house-card:hover { border-color: #c084fc40; transform: translateY(-2px); box-shadow: 0 8px 32px rgba(192,132,252,.1); }
    .card-top { display: flex; align-items: flex-start; gap: 14px; }
    .rank-badge { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; font-weight: 500; font-size: 14px; flex-shrink: 0; }
    .card-body { flex: 1; min-width: 0; }
    .card-title { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: #e2e8f0; }
    .card-addr { font-size: 13px; color: #64748b; margin: 2px 0 10px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { background: #1a1f2e; border: 1px solid #2d3748; border-radius: 8px; padding: 3px 10px; font-size: 12px; }
    .chip-hl { background: #4ade8015; border-color: #4ade8040; }
    .chip span.lbl { color: #64748b; }
    .chip span.val { color: #cbd5e1; font-family: 'DM Mono', monospace; }
    .chip-hl span.val { color: #4ade80; font-weight: 700; }
    .viewed-badge { font-size: 11px; background: #4ade8020; color: #4ade80; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .score-pill { display: inline-block; padding: 4px 12px; border-radius: 20px; font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; }
    .card-notes { margin-top: 12px; padding: 10px 12px; background: #0f1117; border-radius: 8px; font-size: 13px; color: #94a3b8; font-style: italic; border-left: 3px solid #c084fc40; }

    /* Score ring */
    .score-ring-wrap { flex-shrink: 0; }
    .score-ring-outer { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .score-ring-inner { width: 38px; height: 38px; border-radius: 50%; background: #161b27; display: flex; align-items: center; justify-content: center; }
    .score-ring-text { font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 700; }

    /* Section card */
    .section-card { background: #161b27; border: 1px solid #1e2535; border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .section-title { font-size: 13px; font-weight: 600; color: #94a3b8; letter-spacing: .08em; text-transform: uppercase; margin-bottom: 16px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 14px; }
    .field { }
    .computed-field { padding: 8px 12px; background: #0f1117; border-radius: 8px; font-size: 14px; font-family: 'DM Mono', monospace; }

    /* Edit header */
    #edit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 10px; }
    #edit-title { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; }
    #edit-actions { display: flex; gap: 8px; }

    /* URL bar */
    #url-bar { background: #161b27; border: 1px solid #1e2535; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    #url-row { display: flex; gap: 8px; }
    #url-row input { flex: 1; }

    /* Scores grid */
    #scores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap: 20px; }
    .score-item { }
    .score-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .score-item-label { font-size: 14px; color: #cbd5e1; }
    .score-item-right { display: flex; gap: 6px; align-items: center; }
    .score-wt { font-size: 11px; color: #64748b; font-family: 'DM Mono', monospace; }
    .score-val { font-family: 'DM Mono', monospace; font-size: 15px; font-weight: 700; padding: 2px 10px; border-radius: 8px; }
    .score-ticks { display: flex; justify-content: space-between; font-size: 10px; color: #4a5568; margin-top: 2px; font-family: 'DM Mono', monospace; }
    .weighted-total { margin-top: 20px; padding: 16px; background: #0f1117; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
    .weighted-total-label { color: #94a3b8; font-size: 14px; }
    .weighted-total-val { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; }

    /* Tabs */
    #tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .tab { cursor: pointer; padding: 8px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; transition: all .2s; color: #64748b; }
    .tab:hover { color: #94a3b8; }
    .tab.active { background: linear-gradient(135deg,#c084fc20,#818cf820); color: #c084fc; border: 1px solid #c084fc40; }

    /* Empty state */
    #empty { text-align: center; padding: 80px 20px; }
    #empty-icon { font-size: 48px; margin-bottom: 16px; }
    #empty-title { font-size: 18px; font-family: 'Playfair Display', serif; color: #64748b; margin-bottom: 8px; }
    #empty-sub { font-size: 14px; color: #4a5568; margin-bottom: 24px; }

    /* Alert bar */
    .alert { border-radius: 10px; padding: 10px 16px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; margin: 12px 0; }
    .alert-success { background: #4ade8015; border: 1px solid #4ade8040; color: #4ade80; }
    .alert-error   { background: #f8717115; border: 1px solid #f8717140; color: #f87171; }
    .alert-close { background: none; border: none; color: inherit; cursor: pointer; font-size: 16px; }

    /* Loading */
    #loading { display: flex; align-items: center; justify-content: center; height: 60vh; color: #64748b; font-family: 'DM Mono', monospace; }

    /* Config screen */
    #config-screen { max-width: 600px; margin: 80px auto; text-align: center; padding: 40px; background: #161b27; border: 1px solid #1e2535; border-radius: 20px; }
    #config-screen h1 { font-family: 'Playfair Display', serif; font-size: 26px; margin-bottom: 12px; }
    #config-screen p  { color: #94a3b8; font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
    #config-screen code { background: #0f1117; padding: 2px 6px; border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 13px; color: #c084fc; }

    @media (max-width: 600px) {
      #header { padding: 12px 16px; flex-wrap: wrap; gap: 10px; }
      #header-actions { width: 100%; }
    }
  </style>
</head>
<body>

<div id="loading">Loading your houses‚Ä¶</div>
<div id="config-screen" style="display:none">
  <div style="font-size:48px;margin-bottom:16px">üîß</div>
  <h1>Firebase Setup Needed</h1>
  <p>Open <code>index.html</code> in a text editor and replace the <code>firebaseConfig</code> block near the top with your own Firebase project credentials. See the <strong>README.md</strong> included with this file for step-by-step instructions.</p>
</div>

<!-- Header -->
<div id="header" style="display:none">
  <div id="header-left">
    <span style="font-size:24px">üè°</span>
    <div>
      <div id="header-title">House Hunter</div>
      <div id="header-sub">0 properties</div>
    </div>
  </div>
  <div id="header-actions">
    <button class="btn btn-secondary btn-sm" id="btn-weights">‚öôÔ∏è Weights</button>
    <button class="btn btn-secondary btn-sm" id="btn-export">‚¨á Export CSV</button>
    <label class="btn btn-secondary btn-sm" style="cursor:pointer;margin:0">
      ‚¨Ü Import CSV
      <input type="file" accept=".csv" id="csv-import-input" style="display:none" />
    </label>
    <button class="btn btn-primary btn-sm" id="btn-add">+ Add House</button>
  </div>
</div>

<!-- Weights panel -->
<div id="weights-panel">
  <div style="font-size:13px;color:#94a3b8;margin-bottom:16px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;">
    Category Weights (1 = Low, 5 = High)
  </div>
  <div id="weights-grid"></div>
</div>

<!-- Main -->
<div id="app" style="display:none">
  <div id="alert-area"></div>
  <div id="tabs" style="display:none"></div>

  <div id="view-rankings"></div>
  <div id="view-edit"    style="display:none"></div>
</div>

<div id="toast"></div>

<script type="module">
// ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CATEGORIES = [
  { id:"bart",     label:"Proximity to BART",    icon:"üöá" },
  { id:"grocery",  label:"Proximity to Grocery", icon:"üõí" },
  { id:"kitchen",  label:"Kitchen",              icon:"üç≥" },
  { id:"flow",     label:"Flow",                 icon:"üåä" },
  { id:"flip",     label:"Opportunity to Flip",  icon:"üí∞" },
  { id:"school",   label:"School District",      icon:"üè´" },
  { id:"vibe",     label:"Vibe",                 icon:"‚ú®" },
  { id:"finished", label:"How Finished It Is",   icon:"üî®" },
  { id:"privacy",  label:"Privacy",              icon:"üîí" },
];
const DEFAULT_WEIGHTS = Object.fromEntries(CATEGORIES.map(c => [c.id, 3]));
const DEFAULT_SCORES  = Object.fromEntries(CATEGORIES.map(c => [c.id, 5]));
const emptyHouse = () => ({
  id: Date.now().toString(),
  nickname:"", address:"", listPrice:"", predictedSellPrice:"",
  upgradeEstimate:"", sqFeet:"", beds:"", baths:"", garage:"",
  yearBuilt:"", dateListed:"", viewed:false, listingUrl:"", notes:"",
  scores:{ ...DEFAULT_SCORES },
});

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let houses  = [];
let weights = { ...DEFAULT_WEIGHTS };
let editingId = null;
let editForm  = null;

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt$ = v => { const n=parseFloat(String(v||"").replace(/[^0-9.]/g,"")); return isNaN(n)?"":("$"+n.toLocaleString()); };
const finalPrice = h => {
  const s=parseFloat(String(h.predictedSellPrice||"").replace(/[^0-9.]/g,""));
  const u=parseFloat(String(h.upgradeEstimate||"").replace(/[^0-9.]/g,""));
  if(!s&&!u) return null;
  return (s||0)+(u||0);
};
const ppsf = h => {
  const p=parseFloat(String(h.listPrice||"").replace(/[^0-9.]/g,""));
  const q=parseFloat(h.sqFeet);
  if(!p||!q) return "‚Äî";
  return "$"+Math.round(p/q).toLocaleString()+"/sqft";
};
const computeScore = (scores,wts) => {
  let t=0,m=0;
  for(const c of CATEGORIES){ const w=wts[c.id]||1; t+=(scores[c.id]||0)*w; m+=10*w; }
  return m===0?0:Math.round(t/m*100);
};
const scoreColor = s => s>=75?"#4ade80":s>=50?"#facc15":"#f87171";
const esc = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");

function toast(msg, dur=2500) {
  const el=document.getElementById("toast");
  el.textContent=msg; el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), dur);
}

function showAlert(msg, type="success") {
  const area=document.getElementById("alert-area");
  area.innerHTML=`<div class="alert alert-${type}">${esc(msg)}<button class="alert-close" onclick="this.parentElement.remove()">√ó</button></div>`;
}

// ‚îÄ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isConfigured() {
  try {
    return typeof window._fbSave === "function" && typeof window._fbSubscribe === "function";
  } catch(e){ return false; }
}

async function saveToFirebase() {
  if(!isConfigured()) return;
  try {
    await window._fbSave({ houses, weights });
  } catch(e) { toast("‚ö†Ô∏è Save failed: "+e.message, 4000); }
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  document.getElementById("header-sub").textContent = `${houses.length} propert${houses.length===1?"y":"ies"}`;
  renderWeightsPanel();
  if(editingId) renderEdit();
  else renderRankings();
  renderTabs();
}

function renderTabs() {
  const tabs=document.getElementById("tabs");
  if(!editingId){ tabs.style.display="none"; return; }
  tabs.style.display="flex";
  const name = editingId==="new"?"‚ûï New House":`‚úèÔ∏è ${editForm?.nickname||"Editing"}`;
  tabs.innerHTML=`
    <div class="tab ${!editingId||activeView==="rankings"?"active":""}" id="tab-rankings">Rankings</div>
    <div class="tab ${activeView==="edit"?"active":""}" id="tab-edit">${esc(name)}</div>`;
  document.getElementById("tab-rankings").onclick = ()=>{ activeView="rankings"; renderAll(); };
  document.getElementById("tab-edit").onclick     = ()=>{ activeView="edit";     renderAll(); };
}

let activeView = "rankings";

function renderRankings() {
  document.getElementById("view-edit").style.display="none";
  const el=document.getElementById("view-rankings");
  el.style.display="block";
  if(houses.length===0){
    el.innerHTML=`<div id="empty">
      <div id="empty-icon">üè°</div>
      <div id="empty-title">No houses yet</div>
      <div id="empty-sub">Add your first property to get started</div>
      <button class="btn btn-primary" id="empty-add">Add First House</button>
    </div>`;
    document.getElementById("empty-add").onclick=startAdd;
    return;
  }
  const sorted=[...houses].sort((a,b)=>computeScore(b.scores,weights)-computeScore(a.scores,weights));
  const rankColors=["#ffd700","#c0c0c0","#cd7f32"];
  el.innerHTML=sorted.map((h,i)=>{
    const sc=computeScore(h.scores,weights);
    const rc=i<3?rankColors[i]:"#64748b";
    const rbg=i<3?`${rankColors[i]}20`:"#1e2535";
    const fp=finalPrice(h);
    const notes=h.notes?`<div class="card-notes">${esc(h.notes.length>120?h.notes.slice(0,120)+"‚Ä¶":h.notes)}</div>`:"";
    const deg=sc*3.6;
    const col=scoreColor(sc);
    return `<div class="house-card" data-id="${esc(h.id)}">
      <div class="card-top">
        <div class="rank-badge" style="background:${rbg};color:${rc}">${i+1}</div>
        <div class="card-body">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:4px">
            <span class="card-title">${esc(h.nickname||"Unnamed House")}</span>
            ${h.viewed?'<span class="viewed-badge">üëÅ Viewed</span>':""}
            <span class="score-pill" style="background:${col}20;color:${col}">${sc}%</span>
          </div>
          <div class="card-addr">${esc(h.address||"No address")}</div>
          <div class="chips">
            ${h.listPrice?`<div class="chip"><span class="lbl">List: </span><span class="val">${esc(fmt$(h.listPrice))}</span></div>`:""}
            ${fp!==null?`<div class="chip chip-hl"><span class="lbl">Final: </span><span class="val">$${fp.toLocaleString()}</span></div>`:""}
            ${h.sqFeet?`<div class="chip"><span class="lbl">SqFt: </span><span class="val">${Number(h.sqFeet).toLocaleString()}</span></div>`:""}
            ${h.beds?`<div class="chip"><span class="lbl">Beds: </span><span class="val">${esc(h.beds)}</span></div>`:""}
            ${h.baths?`<div class="chip"><span class="lbl">Baths: </span><span class="val">${esc(h.baths)}</span></div>`:""}
            ${h.sqFeet&&h.listPrice?`<div class="chip"><span class="lbl">$/sqft: </span><span class="val">${esc(ppsf(h))}</span></div>`:""}
            ${h.yearBuilt?`<div class="chip"><span class="lbl">Built: </span><span class="val">${esc(h.yearBuilt)}</span></div>`:""}
          </div>
        </div>
        <div class="score-ring-wrap">
          <div class="score-ring-outer" style="background:conic-gradient(${col} ${deg}deg,#1e2535 0deg)">
            <div class="score-ring-inner"><span class="score-ring-text" style="color:${col}">${sc}%</span></div>
          </div>
        </div>
      </div>
      ${notes}
    </div>`;
  }).join("");
  el.querySelectorAll(".house-card").forEach(card=>{
    card.onclick=()=>startEdit(houses.find(h=>h.id===card.dataset.id));
  });
}

function renderWeightsPanel() {
  const grid=document.getElementById("weights-grid");
  grid.innerHTML=CATEGORIES.map(cat=>`
    <div class="weight-row">
      <div class="weight-label-row">
        <span style="font-size:13px;color:#cbd5e1">${cat.icon} ${esc(cat.label)}</span>
        <span class="weight-badge" id="wbadge-${cat.id}">${weights[cat.id]}√ó</span>
      </div>
      <input type="range" min="1" max="5" step="1" value="${weights[cat.id]}" data-cat="${cat.id}" class="weight-slider"/>
    </div>`).join("");
  grid.querySelectorAll(".weight-slider").forEach(sl=>{
    sl.oninput=()=>{
      weights[sl.dataset.cat]=parseInt(sl.value);
      document.getElementById("wbadge-"+sl.dataset.cat).textContent=sl.value+"√ó";
      saveToFirebase();
      renderAll();
    };
  });
}

function renderEdit() {
  document.getElementById("view-rankings").style.display="none";
  const el=document.getElementById("view-edit");
  el.style.display="block";
  const h=editForm;
  const fp=finalPrice(h);
  const scoreRows=CATEGORIES.map(cat=>{
    const sc=h.scores[cat.id]||5;
    const col=sc>=7?"#4ade80":sc>=4?"#facc15":"#f87171";
    const wt=weights[cat.id];
    return `<div class="score-item">
      <div class="score-item-header">
        <span class="score-item-label">${cat.icon} ${esc(cat.label)}</span>
        <div class="score-item-right">
          <span class="score-wt">${wt}√ó wt</span>
          <span class="score-val" id="sval-${cat.id}" style="color:${col};background:${col}15">${sc}/10</span>
        </div>
      </div>
      <input type="range" min="1" max="10" step="1" value="${sc}" class="score-slider" data-cat="${cat.id}"/>
      <div class="score-ticks"><span>1</span><span>5</span><span>10</span></div>
    </div>`;
  }).join("");
  const ws=computeScore(h.scores,weights);
  const wc=scoreColor(ws);
  el.innerHTML=`
    <div id="edit-header">
      <div id="edit-title">${esc(editingId==="new"?"Add New House":h.nickname||"Edit House")}</div>
      <div id="edit-actions">
        ${editingId!=="new"?`<button class="btn btn-danger btn-sm" id="btn-delete">Delete</button>`:""}
        <button class="btn btn-secondary btn-sm" id="btn-cancel">Cancel</button>
        <button class="btn btn-primary btn-sm" id="btn-save-form">Save House</button>
      </div>
    </div>

    <!-- URL -->
    <div id="url-bar">
      <label>Listing URL (paste to auto-populate)</label>
      <div id="url-row">
        <input id="url-input" value="${esc(h.listingUrl||"")}" placeholder="https://www.zillow.com/‚Ä¶" />
        <button class="btn btn-secondary btn-sm" id="btn-autofill" style="white-space:nowrap;flex-shrink:0">‚ú® Auto-fill</button>
      </div>
    </div>

    <!-- Property Info -->
    <div class="section-card">
      <div class="section-title">üè† Property Info</div>
      <div class="form-grid">
        ${field("Nickname *","nickname",h.nickname,"e.g. The Blue House")}
        ${field("Address","address",h.address,"123 Main St, Oakland CA")}
        ${field("List Price ($)","listPrice",h.listPrice,"850000")}
        ${field("Predicted Sell Price ($)","predictedSellPrice",h.predictedSellPrice,"875000")}
        ${field("Upgrade Estimate ($)","upgradeEstimate",h.upgradeEstimate,"30000")}
        ${field("Sq Feet","sqFeet",h.sqFeet,"1800")}
        ${field("Beds","beds",h.beds,"3")}
        ${field("Baths","baths",h.baths,"2")}
        ${field("Garage","garage",h.garage,"Yes / No / 2-car")}
        ${field("Year Built","yearBuilt",h.yearBuilt,"1965")}
        <div class="field"><label>Date Listed</label><input type="date" data-field="dateListed" value="${esc(h.dateListed||"")}"/></div>
        <div class="field"><label>Price per SqFt</label><div class="computed-field" style="color:#c084fc">${esc(ppsf(h))}</div></div>
        ${fp!==null?`<div class="field"><label>Final Price (Sell + Upgrades)</label><div class="computed-field" style="color:#4ade80;font-weight:700">$${fp.toLocaleString()}</div></div>`:""}
      </div>
      <div style="margin-top:12px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;text-transform:none;font-size:14px;color:#cbd5e1">
          <input type="checkbox" id="chk-viewed" ${h.viewed?"checked":""}/>
          We've toured this house
        </label>
      </div>
    </div>

    <!-- Notes -->
    <div class="section-card">
      <div class="section-title">üìù Notes</div>
      <textarea id="notes-area" rows="4" placeholder="What stood out? Concerns? Things to follow up on‚Ä¶" style="resize:vertical">${esc(h.notes||"")}</textarea>
    </div>

    <!-- Scores -->
    <div class="section-card">
      <div class="section-title">‚≠ê Category Scores</div>
      <div id="scores-grid">${scoreRows}</div>
      <div class="weighted-total">
        <span class="weighted-total-label">Weighted Score</span>
        <span class="weighted-total-val" id="total-score-display" style="color:${wc}">${ws}%</span>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button class="btn btn-secondary" id="btn-cancel2">Cancel</button>
      <button class="btn btn-primary"   id="btn-save-form2">Save House</button>
    </div>`;

  // Wire fields
  el.querySelectorAll("[data-field]").forEach(inp=>{
    inp.oninput=()=>{ editForm[inp.dataset.field]=inp.value; refreshComputed(); };
  });
  document.getElementById("chk-viewed").onchange=e=>{ editForm.viewed=e.target.checked; };
  document.getElementById("notes-area").oninput=e=>{ editForm.notes=e.target.value; };

  // Score sliders
  el.querySelectorAll(".score-slider").forEach(sl=>{
    sl.oninput=()=>{
      const v=parseInt(sl.value);
      editForm.scores[sl.dataset.cat]=v;
      const col=v>=7?"#4ade80":v>=4?"#facc15":"#f87171";
      const badge=document.getElementById("sval-"+sl.dataset.cat);
      badge.textContent=v+"/10"; badge.style.color=col; badge.style.background=col+"15";
      const ws2=computeScore(editForm.scores,weights);
      const wc2=scoreColor(ws2);
      const td=document.getElementById("total-score-display");
      td.textContent=ws2+"%"; td.style.color=wc2;
    };
  });

  document.getElementById("btn-autofill").onclick=doAutofill;
  document.getElementById("btn-save-form").onclick=saveForm;
  document.getElementById("btn-save-form2").onclick=saveForm;
  document.getElementById("btn-cancel").onclick=cancelEdit;
  document.getElementById("btn-cancel2").onclick=cancelEdit;
  if(editingId!=="new") document.getElementById("btn-delete").onclick=()=>deleteHouse(editingId);
}

function field(label,key,value,placeholder){
  return `<div class="field"><label>${esc(label)}</label><input data-field="${key}" value="${esc(value||"")}" placeholder="${esc(placeholder)}"/></div>`;
}

function refreshComputed() {
  // re-render just the computed fields without full re-render
  const pEl=document.querySelector(`[data-field="listPrice"]`);
  // just trigger a lightweight re-render of the edit view
  const fp=finalPrice(editForm);
  // update ppsf display
  document.querySelectorAll(".computed-field").forEach(el=>{
    if(el.style.color==="#rgb(192, 132, 252)"||el.style.color==="rgb(192, 132, 252)"||el.style.color==="#c084fc"){
      el.textContent=ppsf(editForm);
    }
    if(el.style.color==="rgb(74, 222, 128)"||el.style.color==="#4ade80"){
      el.textContent=fp!==null?"$"+fp.toLocaleString():"";
    }
  });
}

// ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startAdd() {
  editForm=emptyHouse(); editingId="new"; activeView="edit"; renderAll();
}
function startEdit(house) {
  editForm={ ...house, scores:{ ...house.scores } };
  editingId=house.id; activeView="edit"; renderAll();
}
function cancelEdit() {
  editForm=null; editingId=null; activeView="rankings"; renderAll();
}
function saveForm() {
  if(!editForm) return;
  editForm.listingUrl=document.getElementById("url-input")?.value||editForm.listingUrl;
  if(editingId==="new") houses=[...houses,editForm];
  else houses=houses.map(h=>h.id===editingId?editForm:h);
  saveToFirebase();
  editForm=null; editingId=null; activeView="rankings"; renderAll();
  toast("‚úÖ House saved!");
}
function deleteHouse(id) {
  if(!confirm("Remove this house?")) return;
  houses=houses.filter(h=>h.id!==id);
  saveToFirebase();
  editForm=null; editingId=null; activeView="rankings"; renderAll();
  toast("üóë House removed");
}

// ‚îÄ‚îÄ‚îÄ Auto-fill ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doAutofill() {
  const url=document.getElementById("url-input")?.value?.trim();
  if(!url) return;
  const btn=document.getElementById("btn-autofill");
  btn.textContent="Loading‚Ä¶"; btn.disabled=true;
  try {
    const res=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model:"claude-sonnet-4-20250514",
        max_tokens:800,
        messages:[{role:"user",content:`Given this real estate listing URL: ${url}
Extract all available property details. Return ONLY a JSON object (no markdown) with these fields (empty string if unknown):
{"nickname":"","address":"","listPrice":"","sqFeet":"","beds":"","baths":"","garage":"","yearBuilt":"","dateListed":""}
For listPrice, just the number. For beds/baths just the number. For garage: "Yes", "No", or number of cars. For dateListed use YYYY-MM-DD.`}]
      })
    });
    const data=await res.json();
    const text=(data.content||[]).map(b=>b.text||"").join("");
    const parsed=JSON.parse(text.replace(/```json|```/g,"").trim());
    Object.assign(editForm,parsed,{listingUrl:url});
    renderEdit();
  } catch(e) {
    showAlert("Could not auto-populate from URL ‚Äî please fill in manually.","error");
  }
  btn.textContent="‚ú® Auto-fill"; btn.disabled=false;
}

// ‚îÄ‚îÄ‚îÄ CSV export / import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  const catH=CATEGORIES.map(c=>`score_${c.id}`);
  const headers=["id","nickname","address","listPrice","predictedSellPrice","upgradeEstimate","sqFeet","beds","baths","garage","yearBuilt","dateListed","viewed","listingUrl","notes",...catH];
  const weightRow=["WEIGHTS","","","","","","","","","","","","","","",...CATEGORIES.map(c=>weights[c.id])];
  const rows=houses.map(h=>[
    h.id,h.nickname,h.address,h.listPrice,h.predictedSellPrice,h.upgradeEstimate,
    h.sqFeet,h.beds,h.baths,h.garage,h.yearBuilt,h.dateListed,
    h.viewed?"true":"false",h.listingUrl,
    `"${(h.notes||"").replace(/"/g,'""')}"`,
    ...CATEGORIES.map(c=>h.scores[c.id]??5),
  ]);
  const csv=[headers,weightRow,...rows].map(r=>r.join(",")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="house-hunter.csv"; a.click();
}

function importCSV(e) {
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try {
      const lines=ev.target.result.split("\n").filter(l=>l.trim());
      const headers=lines[0].split(",");
      const imported=[]; let newW={...weights};
      for(let i=1;i<lines.length;i++){
        const cols=[]; let cur="",inQ=false;
        for(const ch of lines[i]){ if(ch==='"'){inQ=!inQ;}else if(ch===","&&!inQ){cols.push(cur);cur="";}else cur+=ch; }
        cols.push(cur);
        const get=n=>(cols[headers.indexOf(n)]||"").trim();
        if(get("id")==="WEIGHTS"){ CATEGORIES.forEach(c=>{const v=parseInt(get(`score_${c.id}`));if(!isNaN(v))newW[c.id]=v;}); continue; }
        const scores={}; CATEGORIES.forEach(c=>{const v=parseInt(get(`score_${c.id}`));scores[c.id]=isNaN(v)?5:v;});
        imported.push({ id:get("id")||Date.now().toString()+i, nickname:get("nickname"), address:get("address"), listPrice:get("listPrice"), predictedSellPrice:get("predictedSellPrice"), upgradeEstimate:get("upgradeEstimate"), sqFeet:get("sqFeet"), beds:get("beds"), baths:get("baths"), garage:get("garage"), yearBuilt:get("yearBuilt"), dateListed:get("dateListed"), viewed:get("viewed")==="true", listingUrl:get("listingUrl"), notes:get("notes").replace(/""/g,'"'), scores });
      }
      if(!imported.length){ showAlert("No houses found in CSV.","error"); return; }
      houses=imported; weights=newW;
      saveToFirebase(); renderAll();
      showAlert(`‚úÖ Imported ${imported.length} houses successfully!`);
    } catch(err){ showAlert("‚ùå Failed to parse CSV. Make sure it was exported from this tool.","error"); }
  };
  reader.readAsText(file); e.target.value="";
}

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showApp() {
  document.getElementById("loading").style.display="none";
  document.getElementById("header").style.display="flex";
  document.getElementById("app").style.display="block";
}

function checkConfig() {
  // Check if placeholder text still present
  return typeof window._fbSave === "function";
}

window.addEventListener("load", () => {
  // Small delay to let the module run
  setTimeout(()=>{
    if(!checkConfig()){
      document.getElementById("loading").style.display="none";
      document.getElementById("config-screen").style.display="block";
      return;
    }

    // Subscribe to Firebase
    window._fbSubscribe(data=>{
      if(data){
        houses  = data.houses  || [];
        weights = data.weights || DEFAULT_WEIGHTS;
      }
      showApp();
      renderAll();
    });

    // Wire buttons
    document.getElementById("btn-weights").onclick=()=>{
      document.getElementById("weights-panel").classList.toggle("open");
    };
    document.getElementById("btn-export").onclick=exportCSV;
    document.getElementById("btn-add").onclick=startAdd;
    document.getElementById("csv-import-input").onchange=importCSV;
  }, 300);
});
</script>
</body>
</html>
